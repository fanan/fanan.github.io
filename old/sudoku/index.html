<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title></title>
    <style type="text/css" media="screen">
td {
  border-style:solid;
  border-width:1px;
  text-align:center;
  width:30px;
  height:30px;
  background-color:#cccccc;
}

.focus {
  background-color:#888888;
}

.solved {
  background-color:#3E50B4;
  color:#FFFFFF;
}
    </style>
  </head>
  <body>
    <div id="instruction">
      使用说明:
      <ol>
        <li>选中对应的格子</li>
        <li>键盘上按1-9输入对应的数字,按0清空</li>
        <li>输入完毕后按"求解"按钮输出答案</li>
        <li>按"重来"可以再来一局</li>
      </ol>
    </div>
    <div id="operation">
      <button id="reset">重来</button>
      <button id="solve">求解</button>
    </div>

    <div id="board">
      <table id="puzzle">
      </table>
    </div>

    <script type="text/javascript" charset="utf-8">
var Puzzle = (function () {
    function Puzzle() {
        this.N = 9;
        this.COL = this.N * this.N * 4;
        this.ROW = this.N * this.N * this.N;
        this.data = [];
        this.solution = [];
        this._init_col = [];
        this._init_row = [];
        this.data.length = this.COL * this.ROW;
        var r = 0;
        var c = 0;
        for (r = 0; r < this.ROW; r++) {
            this._init_row.push(r);
            var value = r % this.N;
            var pos = Math.floor(r / this.N);
            var pos_c = pos % this.N;
            var pos_r = Math.floor(pos / this.N);
            for (c = 0; c < this.COL; c++) {
                var left = c % (this.N * this.N);
                var kind = Math.floor(c / (this.N * this.N));
                if (kind == 0) {
                    if (left == pos_r * this.N + pos_c) {
                        this.set_value(r, c, 1);
                    }
                    else {
                        this.set_value(r, c, 0);
                    }
                }
                else if (kind == 1) {
                    if (left == this.N * pos_r + value) {
                        this.set_value(r, c, 1);
                    }
                    else {
                        this.set_value(r, c, 0);
                    }
                }
                else if (kind == 2) {
                    if (left == this.N * pos_c + value) {
                        this.set_value(r, c, 1);
                    }
                    else {
                        this.set_value(r, c, 0);
                    }
                }
                else {
                    var box = Math.floor(pos_r / 3) * 3 + Math.floor(pos_c / 3);
                    if (left == box * this.N + value) {
                        this.set_value(r, c, 1);
                    }
                    else {
                        this.set_value(r, c, 0);
                    }
                }
            }
        }
        for (c = 0; c < this.COL; c++) {
            this._init_col.push(c);
        }
    }
    Puzzle.prototype.set_value = function (r, c, v) {
        this.data[r * this.COL + c] = v;
    };
    Puzzle.prototype.get_value = function (r, c) {
        return this.data[r * this.COL + c];
    };
    Puzzle.prototype.echo = function () {
        var r = 0;
        var c = 0;
        for (r = 0; r < this.ROW; r++) {
            var s = "";
            for (c = 0; c < this.COL; c++) {
                s += this.get_value(r, c);
                s += ' ';
            }
        }
    };
    Puzzle.prototype.reset = function () {
        this.solution.length = 0;
        this._init_col.length = 0;
        this._init_row.length = 0;
        for (var i = 0; i < this.ROW; ++i) {
            this._init_row.push(i);
        }
        for (var i = 0; i < this.COL; ++i) {
            this._init_col.push(i);
        }
    };
    Puzzle.prototype.add_solution = function (row, removed_rows, removed_cols) {
        
        removed_cols.length = 0;
        removed_rows.length = 0;
        this.solution.push(row);
        for (var j = 0; j < this._init_col.length; j++) {
            if (this.get_value(row, this._init_col[j]) == 1) {
                for (var i = 0; i < this._init_row.length; ++i) {
                    if (this._init_row[i] != -1 && this.get_value(this._init_row[i], this._init_col[j]) == 1) {
                        removed_rows.push(this._init_row[i]);
                        this._init_row[i] = -1;
                    }
                }
                removed_cols.push(this._init_col[j]);
                this._init_col[j] = -1;
            }
        }
        var should_remove = function (v) { return v != -1; };
        this._init_row = this._init_row.filter(should_remove);
        this._init_col = this._init_col.filter(should_remove);
        
    };
    Puzzle.prototype.solve = function () {
        if (this._init_col.length == 0) {
            return true;
        }
        if (this._init_row.length == 0) {
            return false;
        }
        var min = this.N * this.N * this.N + 1;
        var argmin = -1;
        for (var j = 0; j < this._init_col.length; ++j) {
            var count = 0;
            for (var i = 0; i < this._init_row.length; ++i) {
                count += this.get_value(this._init_row[i], this._init_col[j]);
            }
            if (count < min) {
                min = count;
                argmin = this._init_col[j];
            }
        }
        var candidate_row = [];
        for (var i = 0; i < this._init_row.length; ++i) {
            if (this.get_value(this._init_row[i], argmin) == 1) {
                candidate_row.push(this._init_row[i]);
            }
        }
        for (var i = 0; i < candidate_row.length; ++i) {
            var row = candidate_row[i];
            var removed_rows = [];
            var removed_cols = [];
            
            this.add_solution(row, removed_rows, removed_cols);
            
            
            var ret = this.solve();
            if (ret == true) {
                return true;
            }
            this.solution.pop();
            
            this._init_row = this._init_row.concat(removed_rows);
            this._init_col = this._init_col.concat(removed_cols);
        }
        return false;
    };
    Puzzle.prototype.solve_problem = function () {
        if (this.solve() == true) {
            var s = [];
            s.length = 81;
            for (var i = 0; i < this.solution.length; ++i) {
                var row = this.solution[i];
                var value = row % (this.N) + 1;
                var pos = Math.floor(row / this.N);
                s[pos] = value;
            }
            console.log("solution found!");
            for (var i = 0; i < this.N; ++i) {
                var str = "";
                for (var j = 0; j < this.N; ++j) {
                    var pos = i * this.N + j;
                    str += s[pos];
                    str += ' ';
                }
                console.log(str);
            }
            return true;
        }
        else {
            console.log("no solution!");
            return false;
        }
    };
    Puzzle.prototype.add_init = function (r, c, v) {
        console.log(r, c, v);
        var pos = ((r - 1) * this.N + (c - 1)) * this.N + v - 1;
        var dummy_row = [];
        var dummy_col = [];
        this.add_solution(pos, dummy_row, dummy_col);
    };
    return Puzzle;
}());
function solve_table() {
    var b = new Puzzle();
    b.reset();
    var r = 0;
    var c = 0;
    for (r = 0; r < 9; ++r) {
        for (c = 0; c < 9; ++c) {
            var pos = r * 9 + c;
            var v = document.getElementById("td_" + pos).attributes["value"];
            if (v != 0) {
                b.add_init(r + 1, c + 1, v);
            }
        }
    }
    var ret = b.solve_problem();
    if (ret == false) {
        alert("cannot solve puzzle!");
        return;
    }
    for (var i = 0; i < b.solution.length; ++i) {
        var row = b.solution[i];
        var value = row % (b.N) + 1;
        var pos = Math.floor(row / b.N);
        var e = document.getElementById("td_" + pos);
        if (e.attributes["value"] == 0) {
            e.innerText = "" + value;
            e.attributes["value"] = value;
            e.className = "solved";
        }
    }
}
function reset_table() {
    for (var i = 0; i < 81; ++i) {
        var e = document.getElementById("td_" + i);
        e.className = "";
        e.innerText = "";
        e.attributes["value"] = 0;
    }
    document.getElementById("td_0").className = "focus";
    document.getElementById("puzzle").attributes["current"] = 0;
}
function init_table() {
    var table = document.getElementById("puzzle");
    table.attributes["current"] = 0;
    for (var r = 0; r < 9; ++r) {
        var tr = document.createElement("tr");
        var _loop_1 = function(c) {
            var td = document.createElement("td");
            var pos = r * 9 + c;
            td.id = "td_" + pos;
            td.attributes["value"] = 0;
            tr.appendChild(td);
            td.onclick = function () {
                var old = document.getElementById("td_" + table.attributes["current"]);
                old.className = "";
                td.className = "focus";
                table.attributes["current"] = pos;
                console.log(table.attributes["current"]);
            };
        };
        for (var c = 0; c < 9; ++c) {
            _loop_1(c);
        }
        table.appendChild(tr);
    }
    var change_focus = function (new_id) {
        if (new_id < 0 && new_id > 80) {
            return;
        }
        var old_id = table.attributes["current"];
        if (old_id == new_id) {
            return;
        }
        var old = document.getElementById("td_" + table.attributes["current"]);
        old.className = "";
        document.getElementById("td_" + new_id).className = "focus";
        table.attributes["current"] = new_id;
        return;
    };
    var move_right = function () {
        var o = table.attributes["current"];
        if (o < 80) {
            change_focus(o + 1);
        }
    };
    var move_left = function () {
        var o = table.attributes["current"];
        if (o > 0) {
            change_focus(o - 1);
        }
    };
    var move_up = function () {
        var o = table.attributes["current"];
        if (o > 8) {
            change_focus(o - 9);
        }
    };
    var move_down = function () {
        var o = table.attributes["current"];
        if (o < 72) {
            change_focus(o + 9);
        }
    };
    document.getElementById("td_0").className = "focus";
    document.addEventListener("keydown", function (e) {
        var code = e.charCode;
        if (code == 37) {
            move_left();
            return;
        }
        if (code == 38) {
            move_up();
            return;
        }
        if (code == 39) {
            move_right();
            return;
        }
        if (code == 40) {
            move_down();
            return;
        }
        return;
    });
    document.addEventListener("keypress", function (e) {
        console.log("keypressed", e.charCode.valueOf());
        var code = e.charCode;
        if (code >= "1".charCodeAt(0) && code <= "9".charCodeAt(0)) {
            var e_1 = document.getElementById("td_" + table.attributes["current"]);
            e_1.attributes["value"] = code - "0".charCodeAt(0);
            e_1.innerText = String.fromCharCode(code);
            move_right();
            return;
        }
        if (code == "0".charCodeAt(0) || code == " ".charCodeAt(0)) {
            var e_2 = document.getElementById("td_" + table.attributes["current"]);
            e_2.attributes["value"] = 0;
            e_2.innerText = "";
            return;
        }
        if (code == "\t".charCodeAt(0) || code == "l".charCodeAt(0)) {
            move_right();
            return;
        }
        if (code == "h".charCodeAt(0)) {
            move_left();
            return;
        }
        if (code == "j".charCodeAt(0)) {
            move_down();
            return;
        }
        if (code == "k".charCodeAt(0)) {
            move_up();
            return;
        }
        return;
    });
}
init_table();
document.getElementById("reset").onclick = reset_table;
document.getElementById("solve").onclick = solve_table;

    
    
    </script>
  </body>
</html>
